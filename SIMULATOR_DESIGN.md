# Bittensor 子网经济模型模拟器 - 技术设计文档

**版本**: 2.0  
**最后更新**: 2025年1月4日  
**主要开发者**: Claude (AI) & MrHardcandy

---

本文档旨在为团队提供一个全面、深入的技术参考，详细描述 Bittensor 子网经济模型模拟器的架构设计、核心经济学逻辑、内置市值管理策略以及使用方法。

## 第一部分：项目结构与模块职责

本模拟器采用模块化的架构设计，以确保代码的高内聚、低耦合，便于未来扩展和维护。核心逻辑分布在以下几个关键文件中：

### `app.py`
*   **职责**: **应用主入口与用户界面 (UI)**
*   **作用**:
    *   作为整个应用的主启动文件。
    *   使用 `Streamlit` 库构建交互式的 Web 用户界面。
    *   负责渲染所有参数控制滑块、输入框和图表。
    *   捕获用户的交互事件（如点击"运行模拟"按钮），并将前端的参数传递给后端的模拟引擎。
    *   调用模拟引擎执行计算，并格式化、展示返回的结果和图表。

### `src/simulation/simulator.py`
*   **职责**: **主模拟引擎与状态机**
*   **作用**:
    *   包含核心的 `BittensorSubnetSimulator` 类。
    *   管理模拟的整体状态，如当前区块、天数等。
    *   包含按区块推进的主循环 `process_block()`，这是模拟器的心跳。
    *   在每个区块中，协调调用 `amm_pool` 和 `emission` 模块，以更新市场状态和奖励。
    *   执行并管理内置的市值管理策略（`TempoSellStrategy`），根据策略的决策与 AMM 池进行交互。

### `src/core/` (对应文档中的 `protocol_logic.py`)
这个包封装了所有忠实于 `subtensor` 链上规则的核心数学函数和经济模型。
*   **`amm_pool.py`**:
    *   **职责**: **自动做市商 (AMM) 池模型**
    *   **作用**:
        *   实现了基于 `x * y = k` 恒定乘积模型的交易逻辑。
        *   精确处理买卖操作（`swap`）中的价格滑点计算。
        *   模拟了 TAO 和 dTAO 的注入（`injection`）对资金池和价格的影响。
        *   实现了基于 EMA 的移动平均价格（`moving_price`）的计算，这是决定 TAO 发行份额的核心。
*   **`emission.py`**:
    *   **职责**: **发行与奖励分配逻辑**
    *   **作用**:
        *   复现了基于 EMA 价格计算子网 TAO 发行份额的权威公式。
        *   实现了 dTAO 奖励池产生的逻辑。
        *   精确模拟了奖励池的 **18% / 41% / 41%** 宏观分割，以及验证者池基于 `Root Proportion` 的内部"二次分配"。
        *   管理"待分配"奖励池的累积和在每个 Epoch 结束时的清算。

### `configs/default.json` (对应文档中的 `config.py`)
*   **职责**: **全局参数控制中心**
*   **作用**:
    *   提供了一个集中化的配置文件，用于设置所有模拟的初始条件和策略变量（如初始流动性、豁免期、买卖阈值等）。
    *   允许用户在不修改任何 Python 代码的情况下，通过修改这个 JSON 文件来调整模拟的基础设定，极大地提高了灵活性。

---

## 第二部分：核心经济学逻辑复现

我们在 `src/core/` 模块中精确复现了源自 `subtensor` 权威源代码（commit `bfeaf1c...`）的核心经济学公式。

### 1. 子网 TAO 发行公式
一个子网 `i` 在每个区块获得的 TAO 注入量，由其**移动平均价格（EMA Price）**在所有子网的移动平均价格总和中的占比决定。

\[ \text{注入TAO}_i = (\text{全网每区块TAO总发行量}) \times \frac{\text{EMA}_i}{\sum_{j} \text{EMA}_j} \]

*   **`EMA_i`**: 通过指数移动平均公式 `NewEMA = (CurrentPrice * α) + (OldEMA * (1 - α))` 计算得出，其中 `α` (Moving Alpha) 是一个可调的平滑因子。
*   **关键机制**: 此公式确保了只有价格**持续稳定**的子网才能获得更多的 TAO 发行，有效抑制了短期市场操纵。

### 2. dTAO 内部分配
每个区块新产生的 dTAO 奖励池 (`alpha_out`)，在分配给参与者前，会经过一个严格的、分层次的"三步切割"流程：

1.  **所有者分成**: 首先，无条件地将总池的 **18%** 切割出来，专属于子网所有者。
2.  **矿工奖励**: 接着，将总池的 **41%** 切割出来，专属于矿工，其内部分配由本地共识的 `Incentive` 分数决定。
3.  **验证者奖励**: 最后的 **41%** 专属于验证者。但这部分会面临一次**内部的"二次分配"**：
    *   **根分红**: `验证者池 * Root Proportion` 的部分，流向"根分红池"，按验证者在根网的质押比例分配。
    *   **本地分红**: 剩余部分流向"本地奖励池"，按验证者在本子网的 `Bonds` 进行分配。

### 3. AMM 模型
*   我们实现了一个高精度的 `x * y = k` 恒定乘积模型。
*   所有的买卖操作都会产生价格滑点，即实际成交价与当前现货价的偏差，模拟器已内置此计算。
*   为简化模型，当前版本未包含交易手续费逻辑。

---

## 第三部分：内置市值管理策略详解

我们在 `src/strategies/tempo_sell_strategy.py` 中实现了一套完整的三阶段市值管理策略，该策略完全基于我们对 `subtensor` 规则的最终理解，并支持双阶段投资模式。

### **阶段一：价格支撑与积累期 (Accumulation Phase)**
*   **目标**: 在豁免期结束后，当 dTAO 价格处于低位时，动用预算持续买入。此阶段支持两次投资：初始投资和二次增持。
*   **触发条件**: 这是策略的默认初始状态。买入行为只在**豁免期（7200区块）结束之后**才会启动。
*   **核心行为**: 
    *   **初始买入**: 当 `dTAO价格 < 买入阈值` 且预算充足时，策略会以固定的 `买入步长`（TAO数量）执行买入操作。
    *   **二次增持**: 在首次买入后，等待设定的延迟天数，然后进行二次增持。二次增持同样遵循买入阈值和步长规则。
*   **阶段转换**: 当 AMM 池中的 `TAO储备量` 达到 `总投资预算 × 触发倍数` 时，此阶段结束。总投资预算包括初始预算和二次增持金额。

### **阶段二：去风险退出期 (Mass Sell Phase)**
*   **目标**: 这是一个一次性的、关键的风险管理阶段。其核心目标是**卖出大部分已积累的 dTAO，以快速收回初始投资的全部本金**，从而使后续的投资行为处于"零风险"的有利地位。
*   **核心行为**:
    *   **卖出量**: `当前dTAO总余额 - 保留dTAO数量`。
    *   **保留量**: 策略会保留一部分 dTAO（可配置）用于继续质押，以享受长期的验证者收益。
    *   **分批执行**: 为避免对市场造成过大的瞬时冲击，大额卖出操作会被自动拆分成多批、在连续的区块中执行。
*   **阶段转换**: 这是一个短暂的过渡阶段。一旦大规模卖出操作完成，策略会立即转换到最终的"长尾盈利期"。

### **阶段三：长尾盈利期 (Regular Sell Phase)**
*   **目标**: 作为子网的长期利益相关者，持续地、系统性地将未来获得的 dTAO 奖励变现，实现稳定现金流。
*   **核心行为**: 
    *   **奖励变现**: 将在每个 Epoch 周期获得的**所有新增 dTAO 奖励**，在一个很短的固定延迟（如2个区块）后，**全部自动卖出**为 TAO。
    *   **余额管理**: 如果 dTAO 余额超过保留数量，会自动卖出多余部分，确保不会积累过多 dTAO。
*   **ROI计算**: 基于实际总投资金额（初始预算 + 二次增持金额）计算投资回报率，确保准确性。

---

## 第四部分：如何运行与使用

请遵循以下步骤在您的本地计算机上快速启动并运行本模拟器。

1.  **克隆代码库**
    ```bash
    git clone https://github.com/MrHardcandy/bittensor-alpha-simulator.git
    cd bittensor-alpha-simulator
    ```

2.  **创建并激活Python虚拟环境 (推荐)**
    ```bash
    python3 -m venv sim_env
    source sim_env/bin/activate
    ```

3.  **安装所有依赖**
    ```bash
    pip install -r requirements.txt
    ```

4.  **启动Streamlit应用**
    ```bash
    streamlit run app.py
    ```

5.  **访问应用**
    在您的浏览器中打开终端提示的 `Local URL` (通常是 `http://localhost:8501`)。

在打开的 Web 界面中，您可以通过左侧的参数面板调整所有变量，然后点击"运行模拟"来查看结果。

## 第五部分：v2.0 新功能特性

### **双阶段投资策略**
*   **初始投资**: 默认 1000 TAO，作为基础投资金额
*   **二次增持**: 默认 4000 TAO，在首次买入后延迟执行
*   **智能触发**: 基于总投资金额（5000 TAO）计算触发条件
*   **灵活配置**: 支持自定义增持金额和延迟时间

### **精确的ROI计算**
*   **实际投资**: 基于初始投资 + 二次增持的总金额计算
*   **利润分析**: 清晰展示净利润和投资回报率
*   **资产展示**: 实时显示 TAO 和 dTAO 余额及总价值

### **优化的用户界面**
*   **侧边栏配置**: 二次增持参数集中在侧边栏
*   **状态显示**: 实时显示当前策略阶段
*   **错误处理**: 完善的异常处理和用户提示
*   **参数验证**: 自动验证用户输入的合理性

### **增强的策略逻辑**
*   **余额管理**: 自动处理多余 dTAO 的卖出
*   **阶段转换**: 精确的状态机管理
*   **买入控制**: 严格按照阈值和步长执行交易
*   **风险控制**: 基于总投资金额的风险管理 